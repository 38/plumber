#message("--------------------------------------------------------")
file(GLOB_RECURSE servlet_cmakes RELATIVE ${CMAKE_CURRENT_SOURCE_DIR}/${SERVLET_DIR} "${CMAKE_CURRENT_SOURCE_DIR}/${SERVLET_DIR}/*build.cmake")
foreach(servlet_cmake ${servlet_cmakes})
	get_filename_component(servlet_path ${servlet_cmake} DIRECTORY)
	get_filename_component(servlet_dir ${servlet_path} DIRECTORY)
	get_filename_component(servlet ${servlet_path} NAME)
	set(NAMESPACE "${servlet_dir}")
	string(REPLACE "/" "." servlet_logical_name ${NAMESPACE}/${servlet})
	string(REPLACE "/" "_" servlet_config_name ${NAMESPACE}/${servlet})
	if(NOT "${build_${servlet_config_name}}" STREQUAL "no")
		set(SOURCE_PATH ${CMAKE_CURRENT_SOURCE_DIR}/${SERVLET_DIR}/${servlet_dir}/${servlet})
		set(SOURCE "")
		set(LOCAL_CFLAGS )
		set(LOCAL_LIBS )
		set(LOCAL_INCLUDE )
		set(LOCAL_SOURCE )
		set(INSTALL "no")
		include(${CMAKE_SOURCE_DIR}/${SERVLET_DIR}/${servlet_cmake})
		if(NOT "${build_${servlet_config_name}}" STREQUAL "no")
			set(package_status "${package_status} -Dbuild_${servlet_config_name}=yes")
			aux_source_directory(${SOURCE_PATH} SOURCE)
			list(APPEND LOCAL_INCLUDE "${CMAKE_CURRENT_SOURCE_DIR}/${LIB_DIR}/pservlet/include")
			list(APPEND LOCAL_INCLUDE "${CMAKE_CURRENT_SOURCE_DIR}/${SERVLET_DIR}/${servlet_dir}/${servlet}/include")
			list(APPEND LOCAL_LIBS pservlet)
			set_source_files_properties(${SOURCE} ${LOCAL_SOURCE} PROPERTIES COMPILE_FLAGS "${CFLAGS} ${LOCAL_CFLAGS} -fPIC")
			add_library(${servlet_logical_name} SHARED ${SOURCE} ${LOCAL_SOURCE})
			set_target_properties(${servlet_logical_name} PROPERTIES 
			                      OUTPUT_NAME ${servlet}
			                      LIBRARY_OUTPUT_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/bin/servlet/${NAMESPACE})
			target_include_directories(${servlet_logical_name} PUBLIC ${LOCAL_INCLUDE})
			target_link_libraries(${servlet_logical_name} ${LOCAL_LIBS})
			if("${INSTALL}" STREQUAL "yes")
				install(TARGETS ${servlet_logical_name} DESTINATION lib/plumber/servlet/${NAMESPACE})
			endif("${INSTALL}" STREQUAL "yes")
			set(build_${servlet_config_name} "yes")
		else(NOT "${build_${servlet_config_name}}" STREQUAL "no")
			set(package_status "${package_status} -Dbuild_${servlet_config_name}=no")
			set(build_${servlet_config_name} "no")
		endif(NOT "${build_${servlet_config_name}}" STREQUAL "no")
		append_pakage_configure(${servlet_logical_name} servlet ${build_${servlet_config_name}} ${INSTALL})
		compile_protocol_type_files("${servlet}" "${CMAKE_CURRENT_SOURCE_DIR}/${SERVLET_DIR}/${servlet_dir}/${servlet}/protocol")
	endif(NOT "${build_${servlet_config_name}}" STREQUAL "no")
endforeach(servlet_cmake ${servlet_cmakes})
set(PYSERVLET_INCLUDE ${CMAKE_INSTALL_PREFIX}/include/pservlet)
set(PYSERVLET_LIBPATH ${CMAKE_INSTALL_PREFIX}/lib)

if("${SYSNAME}" STREQUAL "DARWIN")
    configure_file("${CMAKE_CURRENT_SOURCE_DIR}/misc/servlet.mk.darwin.in" 
                   "${CMAKE_CURRENT_BINARY_DIR}/servlet.mk")
else("${SYSNAME}" STREQUAL "DARWIN")
    configure_file("${CMAKE_CURRENT_SOURCE_DIR}/misc/servlet.mk.in" 
                   "${CMAKE_CURRENT_BINARY_DIR}/servlet.mk")
endif("${SYSNAME}" STREQUAL "DARWIN")
install(FILES "${CMAKE_CURRENT_BINARY_DIR}/servlet.mk" DESTINATION lib/plumber/)
install(FILES "${CMAKE_CURRENT_SOURCE_DIR}/misc/servlet.cmake" DESTINATION lib/plumber/cmake/)
