#message("--------------------------------------------------------")
file(GLOB_RECURSE servlet_cmakes RELATIVE ${CMAKE_CURRENT_SOURCE_DIR}/${SERVLET_DIR} "${CMAKE_CURRENT_SOURCE_DIR}/${SERVLET_DIR}/*build.cmake")
foreach(servlet_cmake ${servlet_cmakes})
	get_filename_component(servlet_path ${servlet_cmake} DIRECTORY)
	get_filename_component(servlet_dir ${servlet_path} DIRECTORY)
	get_filename_component(servlet ${servlet_path} NAME)
	if(NOT "${build_${servlet}}" STREQUAL "no")
		set(SOURCE_PATH ${CMAKE_CURRENT_SOURCE_DIR}/${SERVLET_DIR}/${servlet_dir}/${servlet})
		set(SOURCE "")
		set(LOCAL_CFLAGS )
		set(LOCAL_LIBS )
		set(LOCAL_INCLUDE )
		set(INSTALL "no")
		set(NAMESPACE "${servlet_dir}")
		include(${CMAKE_SOURCE_DIR}/${SERVLET_DIR}/${servlet_cmake})
		if(NOT "${build_${servlet}}" STREQUAL "no")
			set(package_status "${package_status} -Dbuild_${servlet}=yes")
			aux_source_directory(${SOURCE_PATH} SOURCE)
			list(APPEND LOCAL_INCLUDE "${CMAKE_CURRENT_SOURCE_DIR}/${LIB_DIR}/pservlet/include")
			list(APPEND LOCAL_INCLUDE "${CMAKE_CURRENT_SOURCE_DIR}/${SERVLET_DIR}/${servlet_dir}/${servlet}/include")
			list(APPEND LOCAL_LIBS pservlet)
			set_source_files_properties(${SOURCE} PROPERTIES COMPILE_FLAGS "${CFLAGS} ${LOCAL_CFLAGS} -fPIC")
			add_library(${servlet} SHARED ${SOURCE})
			target_include_directories(${servlet} PUBLIC ${LOCAL_INCLUDE})
			target_link_libraries(${servlet} ${LOCAL_LIBS})
			if("${INSTALL}" STREQUAL "yes")
				install(TARGETS ${servlet} DESTINATION lib/plumber/servlet/${NAMESPACE})
			endif("${INSTALL}" STREQUAL "yes")
			set(build_${servlet} "yes")
		else(NOT "${build_${servlet}}" STREQUAL "no")
			set(package_status "${package_status} -Dbuild_${servlet}=no")
			set(build_${servlet} "no")
		endif(NOT "${build_${servlet}}" STREQUAL "no")
		append_pakage_configure(${servlet} servlet ${build_${servlet}} ${INSTALL})
		compile_protocol_type_files("${servlet}" "${CMAKE_CURRENT_SOURCE_DIR}/${SERVLET_DIR}/${servlet_dir}/${servlet}/protocol")
	endif(NOT "${build_${servlet}}" STREQUAL "no")
endforeach(servlet_cmake ${servlet_cmakes})
set(PYSERVLET_INCLUDE ${CMAKE_INSTALL_PREFIX}/include/pservlet)
set(PYSERVLET_LIBPATH ${CMAKE_INSTALL_PREFIX}/lib)

configure_file("${CMAKE_CURRENT_SOURCE_DIR}/misc/servlet.mk.in" 
               "${CMAKE_CURRENT_BINARY_DIR}/servlet.mk")
install(FILES "${CMAKE_CURRENT_BINARY_DIR}/servlet.mk" DESTINATION lib/plumber/)

